{% extends "base.html" %}

{% block content %}
<div class="container" style="background:#000; color:#fff; padding:30px; border-radius:16px; margin-top:20px; box-shadow:0 0 25px rgba(255,140,0,0.3);">

  <h2 style="color:darkorange; text-align:center; margin-bottom:35px; font-weight:bold;">
    🚚 Track Your Order
  </h2>

  <!-- Order Info -->
  <div style="text-align:center; margin-bottom:30px;">
    <p><b>Order ID:</b> {{ order.id }}</p>
    <p><b>Placed on:</b> {{ order.created_at|date:"M d, Y H:i A" }}</p>
    <p><b>Status:</b> <span id="liveStatus" style="color:darkorange;">{{ order.status|capfirst }}</span></p>
  </div>

  <!-- Progress Tracker -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin:40px 0; position:relative;">
    <!-- Progress line -->
    <div style="position:absolute; top:50%; left:0; right:0; height:6px; background:#333; border-radius:3px; z-index:1;"></div>
    <div id="progressLine" style="position:absolute; top:50%; left:0; height:6px; background:darkorange; border-radius:3px; z-index:2; width:0%; transition:width 0.6s;"></div>

    <!-- Steps -->
    <div style="flex:1; text-align:center; z-index:3;">
      <div id="step-placed" style="width:30px; height:30px; margin:auto; border-radius:50%; background:#333; line-height:30px; color:#000;">1</div>
      <p style="margin-top:8px;">Placed</p>
    </div>
    <div style="flex:1; text-align:center; z-index:3;">
      <div id="step-confirmed" style="width:30px; height:30px; margin:auto; border-radius:50%; background:#333; line-height:30px; color:#000;">2</div>
      <p style="margin-top:8px;">Confirmed</p>
    </div>
    <div style="flex:1; text-align:center; z-index:3;">
      <div id="step-preparing" style="width:30px; height:30px; margin:auto; border-radius:50%; background:#333; line-height:30px; color:#000;">3</div>
      <p style="margin-top:8px;">Preparing</p>
    </div>
    <div style="flex:1; text-align:center; z-index:3;">
      <div id="step-onway" style="width:30px; height:30px; margin:auto; border-radius:50%; background:#333; line-height:30px; color:#000;">4</div>
      <p style="margin-top:8px;">On the Way</p>
    </div>
    <div style="flex:1; text-align:center; z-index:3;">
      <div id="step-delivered" style="width:30px; height:30px; margin:auto; border-radius:50%; background:#333; line-height:30px; color:#000;">5</div>
      <p style="margin-top:8px;">Delivered</p>
    </div>
  </div>

  <!-- Delivery Details -->
<div style="margin-top:40px; padding:20px; border:1px solid darkorange; border-radius:12px;">
  <h3 style="color:darkorange; margin-bottom:15px;">📍 Delivery Info</h3>
  <p><b>Name:</b> {{ order.customer.user.username }}</p>
  <p><b>Phone:</b> {{ order.customer.phone|default:"-" }}</p>
  <p><b>Address:</b> {{ order.address }}</p>
</div>

</div>

<!-- Live Progress Script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  let status = "{{ order.status }}".toLowerCase();
  let steps = ["placed", "confirmed", "preparing", "onway", "delivered"];
  let currentIndex = steps.indexOf(status);

  steps.forEach((step, index) => {
    let stepEl = document.getElementById("step-" + step);
    if (index <= currentIndex) {
      stepEl.style.background = "darkorange";
      stepEl.style.color = "#000";
    }
  });

  let progress = ((currentIndex) / (steps.length - 1)) * 100;
  document.getElementById("progressLine").style.width = progress + "%";

  // Auto-refresh every 10s for live tracking
  setInterval(() => {
    fetch("{% url 'orders:track_status_api' order.id %}")
      .then(res => res.json())
      .then(data => {
        document.getElementById("liveStatus").innerText = data.status;
        let idx = steps.indexOf(data.status.toLowerCase());
        if (idx !== -1) {
          steps.forEach((step, i) => {
            let stepEl = document.getElementById("step-" + step);
            if (i <= idx) {
              stepEl.style.background = "darkorange";
              stepEl.style.color = "#000";
            }
          });
          let prog = ((idx) / (steps.length - 1)) * 100;
          document.getElementById("progressLine").style.width = prog + "%";
        }
      });
  }, 10000);
});
</script>
{% endblock %}
